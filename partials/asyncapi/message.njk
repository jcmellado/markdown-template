{#- Copyright (c) 2020, Juan Mellado. All rights reserved. Use of this
    source is governed by a MIT-style license found in the LICENSE file. -#}

{% from "./binding.njk" import messageBindingsTemplate -%}
{% from "./external-docs.njk" import externalDocsTemplate -%}
{% from "./schema.njk" import schemaTemplate -%}
{% from "./tag.njk" import tagTemplate -%}

{# Message #}

{% macro messagesTemplate(messages, subsections, defaultContentType, slateEnabled) -%}
{% for messageName, message in messages -%}
{{ messageTemplate(message, subsections, defaultContentType, slateEnabled) -}}
{% endfor -%}
{% endmacro -%}

{% macro messageTemplate(message, subsections, defaultContentType, slateEnabled) -%}
## {{ message.name() if message.name() | isDefined else message.uid() }}

{% if message.title() | isDefined -%}
{{ message.title() }}

{% endif -%}
{% if message.summary() | isDefined -%}
{{ message.summary() }}

{% endif -%}
{% if message.description() | isDefined -%}
{{ message.description() | safe }}

{% endif -%}
{% if message.externalDocs() -%}
{{ externalDocsTemplate(message.externalDocs()) -}}
{% endif -%}
{% for subsection in subsections | chunks -%}
{% if subsection === "payload" and message.payload() -%}
### Payload

{{ payloadMessageTemplate(message, defaultContentType, slateEnabled) -}}
{% elif subsection === "headers" and message.headers() -%}
### Headers

{{ schemaTemplate(message.headers()) -}}
{% elif subsection === "correlationId" and message.correlationId() -%}
### Correlation ID

{{ correlationIdMessageTemplate(message.correlationId()) -}}
{% elif subsection === "bindings" and message.bindings() -%}
### Message Bindings

{{ messageBindingsTemplate(message.bindings()) -}}
{% elif subsection === "tags" and message.hasTags() -%}
### Message Tags

{% for tag in message.tags() -%}
#### {{ tag.name() }}

{{ tagTemplate(tag) -}}
{% endfor -%}
{% endif -%}
{% endfor -%}
{% endmacro -%}

{# Payload #}

{% macro payloadMessageTemplate(message, defaultContentType, slateEnabled) -%}
{% if message.contentType() | isDefined or defaultContentType | isDefined -%}
{{ "Content Type:" }} {% if message.contentType() | isDefined -%} {{ message.contentType() | code }} {%- else -%} {{ defaultContentType | code }} {% endif %}

{% endif -%}
{% if message.schemaFormat() | isDefined and message.schemaFormat() !== "application/schema+json;version=draft-07" -%}
{{ "Schema Format:" }} {{ message.schemaFormat() | code }}

{% endif -%}
{% if message.examples() and slateEnabled === "true" -%}
{{ examplesMessageTemplate(message.examples()) -}}
{% endif -%}
{{ schemaTemplate(message.payload()) -}}
{% if message.examples() and slateEnabled === "false" -%}
#### Examples

{{ examplesMessageTemplate(message.examples()) -}}
{% endif -%}
{% endmacro -%}

{# Examples #}

{% macro examplesMessageTemplate(examples) -%}
{% for example in examples -%}
{% set language = example | keys | first -%}
```{{ language }}
{{ example[language] | safe }}
```

{% endfor -%}
{% endmacro -%}

{# Correlation ID #}

{% macro correlationIdMessageTemplate(correlationId) -%}
Location|Description
--------|------------
{{ correlationId.location() | code -}}
|{% if correlationId.description() | isDefined -%} {{ correlationId.description() | safe }} {%- endif %}

{% endmacro -%}
